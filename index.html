
<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <title>普通話拼音選擇遊戲（進階迷惑版）</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { color: #007acc; }
    button { font-size: 18px; padding: 10px 20px; margin: 5px 0; width: 100%; max-width: 400px; }
    .hidden { display: none; }
    .feedback { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
<h1>🎮 普通話拼音選擇遊戲（進階迷惑版）</h1>

<div id="start-screen">
  <label>選擇題數：
    <select id="question-count">
      <option value="5">5題</option>
      <option value="10" selected>10題</option>
      <option value="20">20題</option>
    </select>
  </label>
  <br><br>
  <button onclick="startGame()">開始遊戲</button>
</div>

<div id="game-area" class="hidden">
  <h2 id="word-display"></h2>
  <button onclick="playPronunciation()">🔊 播放發音</button>
  <div id="options"></div>
  <div class="feedback" id="feedback"></div>
  <p>得分：<span id="score">0</span> ／ 題號：<span id="current">1</span> / <span id="total"></span></p>
</div>

<div id="end-screen" class="hidden">
  <h2>🎉 遊戲結束！</h2>
  <p>你的得分是：<span id="final-score"></span></p>
  <button onclick="location.reload()">再玩一次</button>
</div>

<script>
const wordBank = [
  { word: "老師", pinyin: "lǎo shī" },
  { word: "學生", pinyin: "xué shēng" },
  { word: "圖書館", pinyin: "tú shū guǎn" },
  { word: "課本", pinyin: "kè běn" },
  { word: "作業", pinyin: "zuò yè" },
  { word: "上課", pinyin: "shàng kè" },
  { word: "考試", pinyin: "kǎo shì" },
  { word: "鉛筆", pinyin: "qiān bǐ" },
  { word: "數學", pinyin: "shù xué" },
  { word: "白板", pinyin: "bái bǎn" }
];

const confusables = {
  "initials": {
    "zh": [
      "z",
      "ch"
    ],
    "ch": [
      "zh",
      "q"
    ],
    "sh": [
      "s",
      "x"
    ],
    "z": [
      "zh",
      "j"
    ],
    "c": [
      "ch",
      "q"
    ],
    "s": [
      "sh",
      "x"
    ],
    "j": [
      "z",
      "q"
    ],
    "q": [
      "c",
      "ch"
    ],
    "x": [
      "sh",
      "s"
    ],
    "b": [
      "p",
      "d"
    ],
    "d": [
      "b",
      "t"
    ],
    "t": [
      "d",
      "k"
    ],
    "g": [
      "k",
      "h"
    ],
    "k": [
      "g",
      "t"
    ],
    "h": [
      "k",
      "x"
    ]
  },
  "finals": {
    "ang": [
      "an",
      "eng"
    ],
    "eng": [
      "ang",
      "en"
    ],
    "ing": [
      "in",
      "iang"
    ],
    "in": [
      "ing",
      "ian"
    ],
    "ian": [
      "in",
      "iang"
    ],
    "iang": [
      "ian",
      "ing"
    ],
    "ao": [
      "ou",
      "an"
    ],
    "ou": [
      "ao",
      "o"
    ],
    "an": [
      "ang",
      "en"
    ],
    "en": [
      "eng",
      "an"
    ],
    "ong": [
      "eng",
      "uang"
    ]
  }
};

let questions = [];
let current = 0, score = 0, total = 0;

function startGame() {
  total = parseInt(document.getElementById("question-count").value);
  questions = shuffleArray(wordBank).slice(0, total);
  document.getElementById("start-screen").classList.add("hidden");
  document.getElementById("game-area").classList.remove("hidden");
  document.getElementById("total").textContent = total;
  showQuestion();
}

function showQuestion() {
  let item = questions[current];
  document.getElementById("word-display").textContent = item.word;
  document.getElementById("feedback").textContent = "";
  document.getElementById("current").textContent = current + 1;

  let correct = item.pinyin;
  let options = generateConfusableOptions(correct);
  options = shuffleArray([correct, ...options.slice(0, 3)]);

  let container = document.getElementById("options");
  container.innerHTML = "";
  options.forEach(p => {
    let btn = document.createElement("button");
    btn.textContent = p;
    btn.onclick = () => checkAnswer(p, correct);
    container.appendChild(btn);
  });
}

function checkAnswer(selected, correct) {
  let fb = document.getElementById("feedback");
  if (selected === correct) {
    score++;
    fb.textContent = "✅ 正確！";
  } else {
    fb.textContent = `❌ 錯了，正確答案是：${correct}`;
  }
  document.getElementById("score").textContent = score;

  setTimeout(() => {
    current++;
    if (current < total) {
      showQuestion();
    } else {
      endGame();
    }
  }, 1000);
}

function endGame() {
  document.getElementById("game-area").classList.add("hidden");
  document.getElementById("end-screen").classList.remove("hidden");
  document.getElementById("final-score").textContent = `${score} / ${total}`;
}

function playPronunciation() {
  let word = questions[current].word;
  let utter = new SpeechSynthesisUtterance(word);
  utter.lang = "zh-CN";
  speechSynthesis.speak(utter);
}

function shuffleArray(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

function generateConfusableOptions(correct) {
  const tones = {
    'a': ['ā','á','ǎ','à'],
    'e': ['ē','é','ě','è'],
    'i': ['ī','í','ǐ','ì'],
    'o': ['ō','ó','ǒ','ò'],
    'u': ['ū','ú','ǔ','ù'],
    'ü': ['ǖ','ǘ','ǚ','ǜ']
  };
  const toneMap = {
    'ā':'a','á':'a','ǎ':'a','à':'a',
    'ē':'e','é':'e','ě':'e','è':'e',
    'ī':'i','í':'i','ǐ':'i','ì':'i',
    'ō':'o','ó':'o','ǒ':'o','ò':'o',
    'ū':'u','ú':'u','ǔ':'u','ù':'u',
    'ǖ':'ü','ǘ':'ü','ǚ':'ü','ǜ':'ü'
  };
  const removeTone = (pinyin) => pinyin.split('').map(c => toneMap[c] || c).join('');
  const applyTone = (syl) => {
    for (let v in tones) {
      if (syl.includes(v)) {
        return syl.replace(v, tones[v][Math.floor(Math.random()*4)]);
      }
    }
    return syl;
  };

  let noToneParts = removeTone(correct).split(" ");
  let variations = new Set();

  while (variations.size < 10) {
    let variation = noToneParts.map(syl => {
      let init = Object.keys(confusables.initials).find(i => syl.startsWith(i));
      let fin = Object.keys(confusables.finals).find(f => syl.endsWith(f));
      let newSyl = syl;
      if (init && confusables.initials[init]) {
        let newInit = confusables.initials[init][Math.floor(Math.random() * confusables.initials[init].length)];
        newSyl = newSyl.replace(init, newInit);
      }
      if (fin && confusables.finals[fin]) {
        let newFin = confusables.finals[fin][Math.floor(Math.random() * confusables.finals[fin].length)];
        newSyl = newSyl.replace(fin, newFin);
      }
      return applyTone(newSyl);
    }).join(" ");
    if (variation !== correct) variations.add(variation);
  }

  return Array.from(variations);
}
</script>
</body>
</html>
