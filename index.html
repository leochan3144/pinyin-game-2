
<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <title>æ™®é€šè©±æ‹¼éŸ³é¸æ“‡éŠæˆ²ï¼ˆé€²éšè¿·æƒ‘ç‰ˆï¼‰</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { color: #007acc; }
    button { font-size: 18px; padding: 10px 20px; margin: 5px 0; width: 100%; max-width: 400px; }
    .hidden { display: none; }
    .feedback { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
<h1>ğŸ® æ™®é€šè©±æ‹¼éŸ³é¸æ“‡éŠæˆ²ï¼ˆé€²éšè¿·æƒ‘ç‰ˆï¼‰</h1>

<div id="start-screen">
  <label>é¸æ“‡é¡Œæ•¸ï¼š
    <select id="question-count">
      <option value="5">5é¡Œ</option>
      <option value="10" selected>10é¡Œ</option>
      <option value="20">20é¡Œ</option>
    </select>
  </label>
  <br><br>
  <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
</div>

<div id="game-area" class="hidden">
  <h2 id="word-display"></h2>
  <button onclick="playPronunciation()">ğŸ”Š æ’­æ”¾ç™¼éŸ³</button>
  <div id="options"></div>
  <div class="feedback" id="feedback"></div>
  <p>å¾—åˆ†ï¼š<span id="score">0</span> ï¼ é¡Œè™Ÿï¼š<span id="current">1</span> / <span id="total"></span></p>
</div>

<div id="end-screen" class="hidden">
  <h2>ğŸ‰ éŠæˆ²çµæŸï¼</h2>
  <p>ä½ çš„å¾—åˆ†æ˜¯ï¼š<span id="final-score"></span></p>
  <button onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
</div>

<script>
const wordBank = [
  { word: "è€å¸«", pinyin: "lÇo shÄ«" },
  { word: "å­¸ç”Ÿ", pinyin: "xuÃ© shÄ“ng" },
  { word: "åœ–æ›¸é¤¨", pinyin: "tÃº shÅ« guÇn" },
  { word: "èª²æœ¬", pinyin: "kÃ¨ bÄ›n" },
  { word: "ä½œæ¥­", pinyin: "zuÃ² yÃ¨" },
  { word: "ä¸Šèª²", pinyin: "shÃ ng kÃ¨" },
  { word: "è€ƒè©¦", pinyin: "kÇo shÃ¬" },
  { word: "é‰›ç­†", pinyin: "qiÄn bÇ" },
  { word: "æ•¸å­¸", pinyin: "shÃ¹ xuÃ©" },
  { word: "ç™½æ¿", pinyin: "bÃ¡i bÇn" }
];

const confusables = {
  "initials": {
    "zh": [
      "z",
      "ch"
    ],
    "ch": [
      "zh",
      "q"
    ],
    "sh": [
      "s",
      "x"
    ],
    "z": [
      "zh",
      "j"
    ],
    "c": [
      "ch",
      "q"
    ],
    "s": [
      "sh",
      "x"
    ],
    "j": [
      "z",
      "q"
    ],
    "q": [
      "c",
      "ch"
    ],
    "x": [
      "sh",
      "s"
    ],
    "b": [
      "p",
      "d"
    ],
    "d": [
      "b",
      "t"
    ],
    "t": [
      "d",
      "k"
    ],
    "g": [
      "k",
      "h"
    ],
    "k": [
      "g",
      "t"
    ],
    "h": [
      "k",
      "x"
    ]
  },
  "finals": {
    "ang": [
      "an",
      "eng"
    ],
    "eng": [
      "ang",
      "en"
    ],
    "ing": [
      "in",
      "iang"
    ],
    "in": [
      "ing",
      "ian"
    ],
    "ian": [
      "in",
      "iang"
    ],
    "iang": [
      "ian",
      "ing"
    ],
    "ao": [
      "ou",
      "an"
    ],
    "ou": [
      "ao",
      "o"
    ],
    "an": [
      "ang",
      "en"
    ],
    "en": [
      "eng",
      "an"
    ],
    "ong": [
      "eng",
      "uang"
    ]
  }
};

let questions = [];
let current = 0, score = 0, total = 0;

function startGame() {
  total = parseInt(document.getElementById("question-count").value);
  questions = shuffleArray(wordBank).slice(0, total);
  document.getElementById("start-screen").classList.add("hidden");
  document.getElementById("game-area").classList.remove("hidden");
  document.getElementById("total").textContent = total;
  showQuestion();
}

function showQuestion() {
  let item = questions[current];
  document.getElementById("word-display").textContent = item.word;
  document.getElementById("feedback").textContent = "";
  document.getElementById("current").textContent = current + 1;

  let correct = item.pinyin;
  let options = generateConfusableOptions(correct);
  options = shuffleArray([correct, ...options.slice(0, 3)]);

  let container = document.getElementById("options");
  container.innerHTML = "";
  options.forEach(p => {
    let btn = document.createElement("button");
    btn.textContent = p;
    btn.onclick = () => checkAnswer(p, correct);
    container.appendChild(btn);
  });
}

function checkAnswer(selected, correct) {
  let fb = document.getElementById("feedback");
  if (selected === correct) {
    score++;
    fb.textContent = "âœ… æ­£ç¢ºï¼";
  } else {
    fb.textContent = `âŒ éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correct}`;
  }
  document.getElementById("score").textContent = score;

  setTimeout(() => {
    current++;
    if (current < total) {
      showQuestion();
    } else {
      endGame();
    }
  }, 1000);
}

function endGame() {
  document.getElementById("game-area").classList.add("hidden");
  document.getElementById("end-screen").classList.remove("hidden");
  document.getElementById("final-score").textContent = `${score} / ${total}`;
}

function playPronunciation() {
  let word = questions[current].word;
  let utter = new SpeechSynthesisUtterance(word);
  utter.lang = "zh-CN";
  speechSynthesis.speak(utter);
}

function shuffleArray(arr) {
  return arr.sort(() => Math.random() - 0.5);
}

function generateConfusableOptions(correct) {
  const tones = {
    'a': ['Ä','Ã¡','Ç','Ã '],
    'e': ['Ä“','Ã©','Ä›','Ã¨'],
    'i': ['Ä«','Ã­','Ç','Ã¬'],
    'o': ['Å','Ã³','Ç’','Ã²'],
    'u': ['Å«','Ãº','Ç”','Ã¹'],
    'Ã¼': ['Ç–','Ç˜','Çš','Çœ']
  };
  const toneMap = {
    'Ä':'a','Ã¡':'a','Ç':'a','Ã ':'a',
    'Ä“':'e','Ã©':'e','Ä›':'e','Ã¨':'e',
    'Ä«':'i','Ã­':'i','Ç':'i','Ã¬':'i',
    'Å':'o','Ã³':'o','Ç’':'o','Ã²':'o',
    'Å«':'u','Ãº':'u','Ç”':'u','Ã¹':'u',
    'Ç–':'Ã¼','Ç˜':'Ã¼','Çš':'Ã¼','Çœ':'Ã¼'
  };
  const removeTone = (pinyin) => pinyin.split('').map(c => toneMap[c] || c).join('');
  const applyTone = (syl) => {
    for (let v in tones) {
      if (syl.includes(v)) {
        return syl.replace(v, tones[v][Math.floor(Math.random()*4)]);
      }
    }
    return syl;
  };

  let noToneParts = removeTone(correct).split(" ");
  let variations = new Set();

  while (variations.size < 10) {
    let variation = noToneParts.map(syl => {
      let init = Object.keys(confusables.initials).find(i => syl.startsWith(i));
      let fin = Object.keys(confusables.finals).find(f => syl.endsWith(f));
      let newSyl = syl;
      if (init && confusables.initials[init]) {
        let newInit = confusables.initials[init][Math.floor(Math.random() * confusables.initials[init].length)];
        newSyl = newSyl.replace(init, newInit);
      }
      if (fin && confusables.finals[fin]) {
        let newFin = confusables.finals[fin][Math.floor(Math.random() * confusables.finals[fin].length)];
        newSyl = newSyl.replace(fin, newFin);
      }
      return applyTone(newSyl);
    }).join(" ");
    if (variation !== correct) variations.add(variation);
  }

  return Array.from(variations);
}
</script>
</body>
</html>
